<?phpnamespace Supervise\Controller;use Common\Controller\BaseController;class SupervisechatController extends BaseController {	/**	 * @name:supervise_chat_index	 * @desc：约谈列表     * @param：	 * @author：杨凯	 * @addtime:2017-11-29	 * @version：V1.0.0	 **/	public function supervise_chat_index(){		$type = I('get.type');		checkAuth(ACTION_NAME.$type);		$this->assign('type',$type);		$this->display("supervise_chat_index");	}	/**	 * @name:supervise_chat_data	 * @desc：约谈表数据查询	 * @param：	 * @author：杨凯   	 * @addtime:2017-11-29	 * @version：V1.0.0	 **/	public function supervise_chat_data(){	    $count = I('get.limit');	    $page = (I('get.page')-1)*$count;		$str = I('get.start');		$type = I('get.type');		$strt = strToArr($str, ' - ');  //分割时间		$start_time = $strt[0];		$end_time = $strt[1];		$confirm = 'onclick="if(!confirm(' . "'确认删除？'" . ')){return false;}"';		$chat_data = getSuperviseChatList('',$page,$count,$start_time,$end_time,$type);		$communist_name_arr = M('ccp_communist')->getField('communist_no,communist_name');		$party_name_arr = M('ccp_party')->getField('party_no,party_name');		$status_name_arr = M('bd_status')->where("status_group = 'chat_status'")->getField('status_no,status_name');		$status_color_arr = M('bd_status')->where("status_group = 'chat_status'")->getField('status_no,status_color');		$staff_name_arr = M('hr_staff')->getField('staff_no,staff_name');		foreach ($chat_data['data'] as &$chat){			$chat_id = $chat['chat_id'];			$notice_communist=$chat['communist_no'];			$chat['add_time'] = getFormatDate($chat['add_time'], 'Y-m-d');			$chat['update_time'] = getFormatDate($chat['update_time'], 'Y-m-d');			$chat['chat_id'] = "<a class='fcolor-22' href='" . U('supervise_chat_info', array('chat_id' => $chat_id,'type'=>$type,'look'=>1)) . "' target='_self'>".$chat_id."</a>";			$chat['communist_no'] = "<a class='fcolor-22' href='" . U('supervise_chat_info', array('chat_id' => $chat_id,'type'=>$type,'look'=>1)) . "' target='_self'>".$communist_name_arr[$chat['communist_no']]."</a>";			$chat['update_staff'] = getStaffInfo($chat['update_staff']);			//如果审核人信息为空			if(empty($chat['update_staff'])){				$chat['update_staff']='暂无审核人';			}			$chat['party_nome'] = $party_name_arr[$chat['party_no']];			$chat['operate'] = "<a class=' layui-btn layui-btn-primary layui-btn-xs'  href='".U('supervise_chat_info',array('chat_id'=>$chat_id,'type'=>$type,'look'=>1))."' >查看</a>".			"<a class='layui-btn layui-btn-del layui-btn-xs' href='".U('supervise_chat_del',array('chat_id'=>$chat_id,'type'=>$type))."' $confirm>删除 </a>";			//$chat['operate'] = "<a class='btn btn-xs blue btn-outline' >情</a>"."<a class='layui-btn layui-btn-del layui-btn-xs'  href='" . U('supervise_chat_del',array('chat_id'=>$chat_id,'type'=>$type)) . "' $confirm><i class='fa fa-trash-o'></i>删除</a>";			$chat['status_name'] = "<font color='" . $status_color_arr[$chat['status']] . "'>" . $status_name_arr[$chat['status']] . "</font> ";			if ($chat['chat_type']==2){			    $chat['party_manager_name'] = "<a class='fcolor-22' href='" . U('supervise_chat_info', array('chat_id' => $chat_id,'type'=>$type,'look'=>1)) . "' target='_self'>".$staff_name_arr[getPartyInfo($chat['party_no'],'party_manager')]."</a>";				if(empty(strip_tags($chat['party_manager_name']))){					$chat['party_manager_name']='暂无支部负责人';				}			}			if ($chat['status'] == 0) {				$chat['operate'] .="<a class=' layui-btn  layui-btn-xs layui-btn-f60' onclick='chat_hear($type,$chat_id,$notice_communist)' target='_self'><i class='fa fa-edit'></i>邀请</a>";			}		}		$chat_data['code'] =0;		ob_clean();$this->ajaxReturn($chat_data);	}	/**	 * @name:supervise_chat_info	 * @desc:  约谈详情	 * @param：	 * @author：杨凯	 * @addtime:2017-12-07	 * @version：V1.0.0	 **/	public function supervise_chat_info(){		$look = I('get.look');		$this->assign('look',$look);		$chat_id = I('get.chat_id');		//checkAuth(ACTION_NAME);		$chat_data = getSuperviseChatList($chat_id);		$chat_data['communist_name'] = getCommunistInfo($chat_data['communist_no']);		$this->assign('chat_data',$chat_data);		$this->display('supervise_chat_info');	}		/**	 * @name:supervise_chat_save	 * @desc:  保存约谈记录	 * @param：	 * @author：杨凯	 * @addtime:2017-12-07	 * @version：V1.0.0	 **/	public function supervise_chat_save(){		$chat_id = I('get.chat_id');		checkAuth(ACTION_NAME);				$_POST['update_time'] = date("Y-m-d H:i:s");		$_POST['update_staff'] = session('staff_no');		$_POST['status'] = 2;		$supervise_chat = M('supervise_chat');		$case_data = $supervise_chat->save($_POST);		if ($case_data) {			showMsg('success', '记录保存完成！！！', U('supervise_chat_index',array('type'=>$_POST['chat_type'])));		} else {			showMsg('error', '操作失败！！！','');		}	}		/**	 * @name:supervise_chat_del	 * @desc:删除约谈数据	 * @param：	 * @author：杨凯	 * @addtime:2017-11-29	 * @version：V1.0.0	 **/	public function supervise_chat_del(){		$type = I('get.type');		checkAuth(ACTION_NAME.$type);		$supervise_chat = M('supervise_chat');		$chat_id = I('get.chat_id');		$chat_data = $supervise_chat->delete($chat_id);		if ($chat_data) {			showMsg('success', '操作成功！！！',U('supervise_chat_index',array('type'=>$type)));		} else {			showMsg('error', '操作失败！！！','');		}				}	/**	 * @name:supervise_chat_hear	 * @desc：通过预约邀请谈话列表	 * @param：	 * @author：杨凯	 * @addtime:2017-11-29	 * @version：V1.0.0	 **/	public function supervise_chat_hear(){		$type=I('get.type');		$chat_id=I('get.chat_id');		$notice_communist=I('get.notice_communist');		$this->assign('type',$type);		$this->assign('notice_communis',$notice_communist);		$this->assign('chat_id',$chat_id);		$this->display("supervise_chat_hear");	}		/**	 * @name:supervise_chat_status	 * @desc:通过预约邀请谈话	 * @param：	 * @author：杨凯	 * @addtime:2017-11-29	 * @version：V1.0.0	 **/	public function supervise_chat_status(){		$type = I('post.type');		checkAuth(ACTION_NAME.$type);		$supervise_chat = M('supervise_chat');		$chat['chat_id'] = I('post.chat_id');		$chat['status'] = 1;		$chat['update_staff'] = session('staff_no');		$chat['update_time'] =date("Y-m-d H:i:s");		$chat['chat_time'] =I('post.chat_time');		$chat['chat_address'] =I('post.chat_address');		$chat_data = $supervise_chat->save($chat);		if ($chat_data) {			$alert_url ="Supervise/supervisechat/supervise_chat_info/chat_id/".$chat['chat_id'];			$alert_title ="您有一条约谈信息"; 			$notice_communis = I('post.notice_communis'); 			saveAlertMsg('44',$notice_communis, $alert_url, $alert_title, '', '', '', session("staff_no")); 						showMsg('success', '操作成功！！！',U('supervise_chat_index',array('type'=>$type)),2);		} else {			showMsg('error', '操作失败！！！','');		}	}}